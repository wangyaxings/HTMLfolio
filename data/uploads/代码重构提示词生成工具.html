<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件重构提示词生成器 v2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #0056b3;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #495057;
        }
        input[type="text"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box; /* Important */
            font-size: 1rem;
            margin-top: 4px; /* Add space below label */
        }
        input[type="file"] {
             padding: 5px; /* Adjust padding for file input */
             line-height: 1.8; /* Adjust line height */
        }
         select {
            appearance: none; /* Remove default arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            padding-right: 2.5em; /* Make space for arrow */
        }
        textarea {
            min-height: 250px;
            font-family: monospace; /* Better for code */
            resize: vertical;
        }
        button, .button-like {
            display: inline-block; /* Changed for side-by-side */
            padding: 10px 15px; /* Slightly smaller buttons */
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem; /* Adjusted size */
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-right: 10px; /* Space between buttons */
            margin-top: 5px; /* Space above buttons */
            vertical-align: middle;
        }
        button.generate-main {
             display: block;
             width: 100%;
             padding: 12px 20px;
             font-size: 1.1rem;
             margin-top: 20px;
             margin-right: 0;
        }
        button:hover, .button-like:hover {
            background-color: #0056b3;
        }
        button.remove-button {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        button.remove-button:hover {
            background-color: #c82333;
        }
        button.copy-button {
            background-color: #28a745;
            float: right; /* Position copy button */
            margin-left: 10px;
            font-size: 0.9em;
             padding: 5px 10px;
        }
        button.copy-button:hover {
            background-color: #218838;
        }
        .output-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .prompt-output {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            margin-bottom: 20px;
            white-space: pre-wrap; /* Preserve whitespace and wrap */
            word-wrap: break-word; /* Break long words */
            font-family: monospace;
            font-size: 0.95em;
            overflow-x: auto; /* Add scrollbar if needed horizontally */
            position: relative; /* For positioning copy button inside if needed */
            padding-bottom: 40px; /* Space for copy button if inside */
            clear: both; /* Clear floats */
        }
        .prompt-title {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 10px;
             display: block; /* Ensure it's on its own line */
        }
         .prompt-title button.copy-button { /* Style copy button next to title */
            float: right;
            margin-left: 10px;
            margin-top: -5px; /* Adjust vertical alignment */
        }

        .note {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .file-path-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .file-path-input-group input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
            margin-top: 0; /* Reset margin */
        }
        #fileNameDisplay {
            font-style: italic;
            color: #6c757d;
            margin-left: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.6em;
            }
            h2 {
                font-size: 1.3em;
            }
            input[type="text"],
            input[type="file"],
            select,
            textarea,
            button {
                font-size: 0.95em;
            }
             button.copy-button {
                 font-size: 0.8em;
                 padding: 4px 8px;
             }
            .file-path-input-group {
                 flex-direction: column;
                 align-items: stretch;
            }
            .file-path-input-group input[type="text"] {
                 margin-right: 0;
                 margin-bottom: 5px;
            }
             button.remove-button {
                 width: 100%;
             }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>文件重构提示词生成器 v2</h1>
        <p class="note">选择文件，填写信息，然后生成用于文件重构的提示词。请仔细检查并根据实际情况调整。</p>

        <form id="refactorForm">
            <h2>原始文件信息</h2>
             <div class="form-group">
                <label for="fileInput">选择原始文件:</label>
                <input type="file" id="fileInput" name="fileInput" accept=".py,.js,.java,.cs,.ts,.cpp,.c,.h,.php,.rb,.go,.html,.css,text/plain,.txt">
                <span id="fileNameDisplay"></span>
            </div>
             <div class="form-group">
                <label for="language">编程语言 (根据文件后缀自动判断，可手动修改):</label>
                <select id="language" name="language" required>
                    <option value="" disabled selected>--选择或由文件判断--</option>
                    <option value="Python">Python (.py)</option>
                    <option value="JavaScript">JavaScript (.js)</option>
                    <option value="TypeScript">TypeScript (.ts)</option>
                    <option value="Java">Java (.java)</option>
                    <option value="CSharp">C# (.cs)</option> <option value="HTML">HTML (.html)</option>
                    <option value="CSS">CSS (.css)</option>
                    <option value="PHP">PHP (.php)</option>
                    <option value="Ruby">Ruby (.rb)</option>
                    <option value="Go">Go (.go)</option>
                    <option value="C++">C++ (.cpp, .cxx, .h, .hpp)</option>
                    <option value="C">C (.c, .h)</option>
                    <option value="Text">Plain Text (.txt)</option>
                    <option value="Other">Other</option>
                </select>
            </div>
             <div class="form-group">
                <label for="purpose">文件主要功能/目的:</label>
                <input type="text" id="purpose" name="purpose" placeholder="例如：处理用户认证, 执行数据清洗任务" required>
            </div>
            <div class="form-group">
                <label for="projectInfo">所属项目/框架 (可选):</label>
                <input type="text" id="projectInfo" name="projectInfo" placeholder="例如：Django 应用, React 组件, Spring Boot 服务">
            </div>

            <h2>原始代码内容</h2>
            <div class="form-group">
                <label for="originalCode">文件内容 (从选定文件加载):</label>
                <textarea id="originalCode" name="originalCode" readonly required></textarea> </div>

            <h2>重构规划：新文件列表</h2>
            <p class="note">添加重构后每个新模块的文件路径或名称。这些将用于生成第二、三、四步提示词。</p>
            <div id="newFilesContainer">
                 <label>新文件路径/名称:</label>
                </div>
            <button type="button" onclick="addFilePathInput()">+ 添加新文件路径</button>

             <input type="hidden" id="actualFileName" name="actualFileName">

            <button type="button" class="generate-main" onclick="generatePrompts()">生成所有提示词</button>
        </form>

        <div class="output-section" id="outputSection" style="display: none;">
            <h2>生成的提示词</h2>

            <div class="prompt-group">
                 <div class="prompt-title">
                     第一步：分析与规划
                     <button type="button" class="copy-button" onclick="copyToClipboard('prompt1Output')">复制</button>
                 </div>
                <pre id="prompt1Output" class="prompt-output"></pre>
            </div>

            <div class="prompt-group">
                 <div class="prompt-title">
                     第二步：代码生成与内部引用处理
                     <button type="button" class="copy-button" onclick="copyToClipboard('prompt2Output')">复制</button>
                 </div>
                 <p class="note">请在审阅并同意第一步的规划方案后使用此提示词。</p>
                <pre id="prompt2Output" class="prompt-output"></pre>
            </div>

            <div class="prompt-group">
                 <div class="prompt-title">
                     第三步：外部引用更新识别
                     <button type="button" class="copy-button" onclick="copyToClipboard('prompt3Output')">复制</button>
                 </div>
                <pre id="prompt3Output" class="prompt-output"></pre>
            </div>

             <div class="prompt-group">
                 <div class="prompt-title">
                     第四步：验证与测试策略 (可选)
                     <button type="button" class="copy-button" onclick="copyToClipboard('prompt4Output')">复制</button>
                 </div>
                <pre id="prompt4Output" class="prompt-output"></pre>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const actualFileNameInput = document.getElementById('actualFileName');
        const languageSelect = document.getElementById('language');
        const originalCodeTextarea = document.getElementById('originalCode');
        const newFilesContainer = document.getElementById('newFilesContainer');

        // --- Language Inference Map ---
        const extensionMap = {
            'py': 'Python',
            'js': 'JavaScript',
            'ts': 'TypeScript',
            'java': 'Java',
            'cs': 'CSharp', // Matched select value
            'html': 'HTML',
            'css': 'CSS',
            'php': 'PHP',
            'rb': 'Ruby',
            'go': 'Go',
            'cpp': 'C++',
            'cxx': 'C++',
            'h': 'C', // Default C/C++ headers to C, can be overridden
            'hpp': 'C++',
            'c': 'C',
            'txt': 'Text',
            '': 'Text' // Default for no extension
        };

        function inferLanguage(filename) {
            const extension = filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2).toLowerCase();
            return extensionMap[extension] || 'Other'; // Default to 'Other' if not found
        }

        // --- Event Listener for File Input ---
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                fileNameDisplay.textContent = `已选择: ${file.name}`;
                actualFileNameInput.value = file.name; // Store the actual filename

                // Infer and set language
                const inferredLang = inferLanguage(file.name);
                const langOptionExists = Array.from(languageSelect.options).some(opt => opt.value === inferredLang);

                if (langOptionExists) {
                    languageSelect.value = inferredLang;
                } else {
                     languageSelect.value = 'Other'; // Fallback if inferred lang not in list
                }
                languageSelect.disabled = false; // Ensure it's enabled

                // Read file content
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalCodeTextarea.value = e.target.result;
                    originalCodeTextarea.readOnly = false; // Allow editing if needed after load
                };
                reader.onerror = function(e) {
                     alert('读取文件时出错: ' + e.target.error);
                     fileNameDisplay.textContent = '读取文件失败';
                     originalCodeTextarea.value = '';
                     actualFileNameInput.value = '';
                }
                reader.readAsText(file);
            } else {
                 fileNameDisplay.textContent = '';
                 actualFileNameInput.value = '';
                 originalCodeTextarea.value = '';
                 originalCodeTextarea.readOnly = true;
                 languageSelect.value = ""; // Reset language
                 // languageSelect.disabled = true; // Disable if no file? Maybe not necessary
            }
        });

        // --- Dynamic File Path Input Management ---
         function createFilePathInput(isFirst = false) {
            const div = document.createElement('div');
            div.className = 'file-path-input-group';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = '粘贴或输入新文件路径/名称...';
            input.className = 'new-file-path'; // Add class for selection later
            input.required = true; // Make it required? Maybe not strictly

            div.appendChild(input);

            if (!isFirst) { // Don't add remove button for the first input
                 const removeBtn = document.createElement('button');
                 removeBtn.type = 'button';
                 removeBtn.textContent = '移除';
                 removeBtn.className = 'remove-button';
                 removeBtn.onclick = function() {
                     div.remove();
                 };
                 div.appendChild(removeBtn);
            }

            return div;
        }

        function addFilePathInput() {
            newFilesContainer.appendChild(createFilePathInput());
        }

        // Add the first input field initially when the page loads
        document.addEventListener('DOMContentLoaded', () => {
             newFilesContainer.appendChild(createFilePathInput(true)); // Add the first one without a remove button
        });


        // --- Prompt Generation ---
        function generatePrompts() {
            // --- Get Input Values ---
            const fileName = actualFileNameInput.value.trim() || '[文件名]'; // Use stored filename
            const language = languageSelect.value || 'Other'; // Get from select
            const languageDisplay = language === 'Other' ? '[请指定语言]' : language; // How to display 'Other' in prompt
            const purpose = document.getElementById('purpose').value.trim() || '[简要描述该文件的作用]';
            const projectInfo = document.getElementById('projectInfo').value.trim() || '[未提供项目/框架信息]';
            const originalCode = originalCodeTextarea.value.trim();

            // Basic validation check
            if (!fileName || fileName === '[文件名]') {
                 alert('请先选择一个原始文件。');
                 return;
            }
            if (!languageSelect.value) {
                alert('请选择编程语言。');
                return;
            }
             if (!originalCode) {
                alert('无法读取文件内容或文件为空，请确保文件已正确加载。');
                return;
            }


            // Get New File Paths
            const filePathInputs = newFilesContainer.querySelectorAll('.new-file-path');
            const newFilePaths = Array.from(filePathInputs)
                                      .map(input => input.value.trim())
                                      .filter(path => path !== ''); // Filter out empty inputs

            if (newFilePaths.length === 0) {
                alert('请至少添加一个重构后的新文件路径/名称。');
                return;
            }

            const newFileNamesList = newFilePaths.map(path => `\`${path}\``).join(', ');
            const planSummary = `[根据第一步分析结果，描述 ${newFileNamesList} 各自包含的内容]`; // Placeholder summary

            // --- Construct Prompts ---

            // Prompt 1: Analysis & Planning
            const prompt1 = `# 角色：代码架构师
# 任务：分析并规划文件重构方案

请仔细分析以下提供的文件内容（来自 \`${fileName}\`）。

**文件信息：**
* **编程语言：** \`${languageDisplay}\`
* **主要功能/目的：** \`${purpose}\`
* **所属项目/框架（可选）：** \`${projectInfo}\`

**原始文件代码：**
\`\`\`${language.toLowerCase().split(' ')[0]}
${originalCode || '[原始代码未加载]'}
\`\`\`

**分析要求：**
1.  **识别核心功能块：** 找出文件中可以独立出来的主要功能区域、类、函数集合、常量定义等。
2.  **提出模块化方案：**
    * 建议将原始文件拆分成哪些新的文件（请给出建议的文件名/路径，例如 \`auth_utils.py\`, \`data_processing.py\`, \`constants.py\` 等）。
    * 清晰地说明每个新文件应该包含原始代码中的哪些部分（哪些类、函数、常量等）。
    * 解释你这样划分模块的理由（例如：基于功能内聚性、减少耦合、提高可复用性等）。
3.  **识别内部依赖：** 指出在拆分后，新文件之间可能产生的相互依赖关系。

**输出：** 请提供一份详细的重构规划报告，包括建议的新文件结构、每个文件包含的内容、划分理由以及预期的内部依赖关系。**此刻请不要生成实际代码。**`;

            // Prompt 2: Code Generation
            const prompt2 = `# 角色：重构工程师
# 任务：根据规划方案生成新模块的代码并处理内部引用

基于我们之前讨论并确定的重构规划方案（如下简述或引用之前的方案），请为以下规划好的新文件生成完整的代码：

**重构规划（关键点）：**
* **新文件列表：** ${newFileNamesList}
* **文件内容分配：** ${planSummary}
* **核心要求：** 保持原有功能逻辑完全不变。

**生成要求：**
1.  **生成新文件代码：** 为列表中的每一个新文件 (${newFileNamesList}) 生成完整的代码。
2.  **处理内部引用：**
    * 确保在新文件内部，正确导入（import/require/using 等）其他新文件中定义的类、函数、常量等。
    * 移除或注释掉原始文件 \`${fileName}\` 中不再需要的代码（因为它们已被移动到新文件）。
3.  **保持功能一致：** 严格遵循原始代码的逻辑和行为，不要添加新功能或修改现有功能。
4.  **代码风格：** 尽量保持与原始代码一致的编码风格和注释。

**输出：** 请分别提供每个新文件的完整代码内容。可以使用代码块清晰地标识出每个文件的代码。`;


            // Prompt 3: Dependency Updates
            const prompt3 = `# 角色：依赖关系分析师
# 任务：识别项目中其他可能引用了原始文件的代码，并指出需要修改的地方

我们已经将原始文件 \`${fileName}\` 成功拆分成了以下新文件：${newFileNamesList}。

现在，请考虑在整个项目中，**除了这些新拆分出来的文件之外**，可能还有**其他**文件之前直接引用了原始文件 \`${fileName}\` 中的类、函数、常量或变量。

**分析要求：**
1.  **识别潜在引用点：** 基于原始文件 \`${fileName}\` 中定义的公共接口（可被外部使用的类、函数、常量等），推测项目中的哪些其他类型的文件或模块 *可能* 会引用它们。
2.  **提供修改示例：**
    * 对于每一个被移动到新文件的公共元素（例如，一个类 \`MyClass\` 从 \`${fileName}\` 移动到了 \`[某个新文件路径/名称]\`），请指出在其他文件中，原来的引用语句（例如 \`from ${fileName.split('.')[0]} import MyClass\` 或 \`require('./${fileName.split('.')[0]}').MyClass\`）应该如何修改，以指向其在新文件 (\`[某个新文件路径/名称]\`) 中的位置。
    * 提供清晰的“旧引用”和“新引用”对比示例。

**输出：** 请提供一份报告，列出可能需要修改的外部引用模式，并给出具体的修改前后对比示例。**注意：** AI 可能无法直接扫描你的整个项目，所以这里的输出是基于推测和模式识别的建议，你需要根据实际项目结构进行检查。`;


            // Prompt 4: Verification Strategy
            const prompt4 = `# 角色：质量保证工程师
# 任务：建议验证重构效果的策略

文件 \`${fileName}\` 的重构已经完成（或计划完成），代码被拆分到了 ${newFileNamesList} 中，并且相关的内外部引用也已（理论上）更新。

**要求：**
请提出一套策略或建议，用于验证这次重构是否成功，即：
1.  **功能一致性：** 如何确认重构后的代码与原始代码在功能表现上完全一致？
2.  **完整性：** 如何确保所有必要的代码都被迁移，并且所有相关的引用都已正确更新？

**建议方向（可以包括但不限于）：**
* 单元测试（Unit Tests）
* 集成测试（Integration Tests）
* 端到端测试（End-to-End Tests）
* 代码审查（Code Review）侧重点（检查接口、依赖、逻辑不变性）
* 回归测试（Regression Testing）
* 利用版本控制系统（如 Git）进行差异比较和回滚准备

**输出：** 请提供一份简洁的验证策略建议列表。`;


            // --- Display Prompts ---
            document.getElementById('prompt1Output').textContent = prompt1;
            document.getElementById('prompt2Output').textContent = prompt2;
            document.getElementById('prompt3Output').textContent = prompt3;
            document.getElementById('prompt4Output').textContent = prompt4;

            // Show the output section
            document.getElementById('outputSection').style.display = 'block';

             // Scroll to the output section smoothly
            document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- Copy to Clipboard Function ---
        function copyToClipboard(elementId) {
            const textToCopy = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                // Optional: Add visual feedback (e.g., briefly change button text)
                const copyButton = document.querySelector(`button[onclick="copyToClipboard('${elementId}')"]`);
                if (copyButton) {
                    const originalText = copyButton.textContent;
                    copyButton.textContent = '已复制!';
                    copyButton.style.backgroundColor = '#218838'; // Darker green
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                        copyButton.style.backgroundColor = '#28a745'; // Original green
                    }, 1500); // Revert after 1.5 seconds
                }
            }).catch(err => {
                console.error('无法复制文本: ', err);
                alert('复制失败，请手动复制。');
            });
        }

    </script>
</body>
</html>